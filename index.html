<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IDSS Yearbook — Flipbook</title>
  <meta name="description" content="Interactive yearbook flipbook — responsive, accessible and optimized for GitHub Pages / local testing." />

  <!-- External libs (CDN) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>

  <!-- Fonts & simple variables -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f4f6f8;
      --card: #ffffff;
      --accent: #0b63d6;
      --muted: #6b7280;
      --shadow: 0 8px 30px rgba(16,24,40,0.08);
      --radius: 12px;
      --max-width: 1200px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Inter',system-ui,Arial,sans-serif;background:var(--bg);color:#111}

    .page-wrap{max-width:var(--max-width);margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#34a0ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    .title{font-weight:600;font-size:18px}
    .subtitle{color:var(--muted);font-size:13px}

    .controls-row{display:flex;gap:12px;align-items:center}
    .btn{background:var(--card);border:none;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);cursor:pointer;display:inline-flex;gap:8px;align-items:center}
    .btn.primary{background:var(--accent);color:#fff}
    .btn:hover{transform:translateY(-2px)}

    /* Layout */
    .viewer{display:grid;grid-template-columns:1fr 320px;gap:18px}

    /* Flipbook container */
    #flipbook-wrap{background:transparent;display:flex;align-items:center;justify-content:center}
    #flipbook{width:800px;height:1131px;background:transparent;box-shadow:var(--shadow);border-radius:10px;overflow:hidden}
    #flipbook .page{background:var(--card);display:flex;align-items:center;justify-content:center}
    #flipbook .page img{width:100%;height:auto;object-fit:contain;display:block}

    /* Sidebar */
    .sidebar{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);height:fit-content}
    .progress{height:10px;background:#e6eefc;border-radius:999px;overflow:hidden;margin:8px 0}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#34a0ff);width:0%}
    .thumbs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
    .thumbs img{width:100%;aspect-ratio:3/4;object-fit:cover;border-radius:6px;cursor:pointer;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .meta{font-size:13px;color:var(--muted)}

    /* Footer controls */
    .nav{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:12px}
    .page-indicator{font-weight:600}

    /* Small screens: show single column */
    @media (max-width:980px){
      .viewer{grid-template-columns:1fr}
      #flipbook{width:90vw;height:calc(90vw * 1.414)}
    }

    /* Accessibility focus */
    button:focus{outline:3px solid rgba(11,99,214,0.2)}
  </style>
</head>
<body>
  <div class="page-wrap">
    <header>
      <div class="brand">
        <div class="logo">ID</div>
        <div>
          <div class="title">IDSS Yearbook — Graduation 2016–2025</div>
          <div class="subtitle">Interactive flipbook · Responsive · Accessible</div>
        </div>
      </div>

      <div class="controls-row">
        <button class="btn" id="downloadPdfBtn" title="Download as PDF">⬇️ Preuzmi PDF</button>
        <button class="btn" id="fullscreenBtn" title="Fullscreen">⛶ Fullscreen</button>
        <button class="btn primary" id="openBtn">Otvoriti flipbook</button>
      </div>
    </header>

    <main class="viewer">
      <section id="flipbook-wrap">
        <div id="loadingBox" style="text-align:center;padding:36px;background:var(--card);border-radius:12px;box-shadow:var(--shadow);">
          <div style="font-weight:600;margin-bottom:6px">Učitavanje slika...</div>
          <div class="meta">Strpljenje — optimiziram slike i pripremam flipbook</div>
          <div class="progress" aria-hidden><i></i></div>
        </div>

        <!-- Flipbook placeholder; will be replaced when ready -->
        <div id="flipbook" aria-live="polite" style="display:none"></div>
      </section>

      <aside class="sidebar" aria-label="Kontrole i pregled">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:600">Pregled</div>
          <div class="meta" id="loadedCount">0 / 0</div>
        </div>

        <div class="progress" style="margin-top:8px"><i id="progressBar"></i></div>

        <div style="margin-top:10px">
          <div class="meta">Miniatura</div>
          <div class="thumbs" id="thumbs"></div>
        </div>

        <div style="margin-top:12px">
          <div class="meta">Navigacija</div>
          <div class="nav" style="margin-top:8px">
            <button class="btn" id="prev">⟵ Prethodna</button>
            <div class="page-indicator" id="pageIndicator">—</div>
            <button class="btn" id="next">Sljedeća ⟶</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="meta">Tipke</div>
          <div class="meta">← → za navigaciju, F za fullscreen, P za preuzimanje</div>
        </div>

      </aside>
    </main>

  </div>

  <script>
    (function($){
      // ----- CONFIG -----
      const images = [
        "https://i.imgur.com/bFZhsvg.jpeg",
        "https://i.imgur.com/S10UScm.jpeg",
        "https://i.imgur.com/LcGyY3F.jpeg",
        "https://i.imgur.com/bsINYxk.jpeg",
        "https://i.imgur.com/Peee2wx.jpeg",
        "https://i.imgur.com/Q8ThB1H.jpeg",
        "https://i.imgur.com/bUVOUK2.jpeg",
        "https://i.imgur.com/hgHIeyM.jpeg",
        "https://i.imgur.com/PCeM1Ez.jpeg",
        "https://i.imgur.com/1cASFtz.jpeg",
        "https://i.imgur.com/vtTH7Ym.jpeg",
        "https://i.imgur.com/j3QnSYs.jpeg",
        "https://i.imgur.com/nii6vMk.png",
        "https://i.imgur.com/151s4ek.png",
        "https://i.imgur.com/2DgcdNg.jpeg",
        "https://i.imgur.com/nqG6R76.jpeg",
        "https://i.imgur.com/AFX4Axa.jpeg",
        "https://i.imgur.com/z1UJ0pq.jpeg",
        "https://i.imgur.com/EhD610r.jpeg",
        "https://i.imgur.com/xSlrz4m.png",
        "https://i.imgur.com/6oBDOb9.jpeg",
        "https://i.imgur.com/07R6EqR.jpeg",
        "https://i.imgur.com/d0CEELJ.jpeg",
        "https://i.imgur.com/rIS5qpZ.jpeg"
      ];

      const total = images.length;
      let loaded = 0;
      const progressEl = document.getElementById('progressBar');
      const loadedCount = document.getElementById('loadedCount');
      const thumbs = document.getElementById('thumbs');
      const flipbookEl = $('#flipbook');
      const loadingBox = document.getElementById('loadingBox');

      // Accessibility: announce changes
      function setPageIndicator(text){ document.getElementById('pageIndicator').textContent = text }

      // Preload with robust error handling
      function preloadAll(){
        images.forEach((src, i) => {
          const img = new Image();
          img.crossOrigin = 'anonymous'; // try to reduce CORS problems
          img.onload = ()=> onImageLoad(i, src);
          img.onerror = ()=> onImageError(i);
          img.src = src;

          // Create thumbnail placeholder; will update src on success
          const t = document.createElement('img');
          t.alt = 'Thumb ' + (i+1);
          t.dataset.index = i;
          t.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='240' height='320'><rect width='100%' height='100%' fill='%23eef4ff'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%238aa5ff' font-size='14'>Loading</text></svg>`);
          t.addEventListener('click', ()=> goToPage(i+1));
          thumbs.appendChild(t);
        });
        loadedCount.textContent = `0 / ${total}`;
      }

      function onImageLoad(i, src){
        loaded++;
        updateProgress();

        // update thumbnail
        const tn = thumbs.querySelector(`img[data-index='${i}']`);
        if(tn) tn.src = src;

        if(loaded === total){
          initFlipbook();
        }
      }

      function onImageError(i){
        loaded++;
        updateProgress();
        const tn = thumbs.querySelector(`img[data-index='${i}']`);
        if(tn) tn.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='240' height='320'><rect width='100%' height='100%' fill='%23f8d7da'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23b02a37' font-size='14'>Unavailable</text></svg>`);
        // Replace images[i] with placeholder so flipbook never breaks
        images[i] = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='1600' height='2260'><rect width='100%' height='100%' fill='%23ffffff'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23999' font-size='36'>Slika nije dostupna</text></svg>`);
        if(loaded === total) initFlipbook();
      }

      function updateProgress(){
        const pct = Math.round((loaded / total) * 100);
        progressEl.style.width = pct + '%';
        // small animation on top loader
        document.querySelectorAll('#loadingBox .progress > i')[0].style.width = pct + '%';
        loadedCount.textContent = `${loaded} / ${total}`;
      }

      // Init Turn.js and UI wiring
      function initFlipbook(){
        // build pages
        flipbookEl.empty();
        images.forEach((src, i) => {
          const cls = (i===0 || i===images.length-1) ? 'hard page' : 'page';
          const el = $(`<div class='${cls}'><img src='${src}' alt='Page ${i+1}'/></div>`);
          flipbookEl.append(el);
        });

        // hide loader, show book
        loadingBox.style.display = 'none';
        flipbookEl.show();

        // init turn
        flipbookEl.turn({
          width: flipbookEl.width(),
          height: flipbookEl.height(),
          autoCenter: true,
          display: (window.innerWidth < 980) ? 'single' : 'double',
          acceleration: true,
          gradients: true,
          elevation: 60
        });

        // set initial page indicator
        setPageIndicator('1 / ' + images.length);

        // add events
        flipbookEl.bind('turned', function(e, page, view) {
          setPageIndicator(page + ' / ' + images.length);
        });

        // next/prev hooks
        $('#prev').on('click', ()=> flipbookEl.turn('previous'));
        $('#next').on('click', ()=> flipbookEl.turn('next'));

        // keyboard
        $(document).on('keydown', function(e){
          if(e.key === 'ArrowLeft') flipbookEl.turn('previous');
          if(e.key === 'ArrowRight') flipbookEl.turn('next');
          if(e.key.toLowerCase() === 'f') toggleFullscreen();
          if(e.key.toLowerCase() === 'p') downloadPdf();
        });

        // thumbnails sync: click jumps
        document.querySelectorAll('#thumbs img').forEach(t => t.addEventListener('click', (ev)=>{
          const idx = +ev.currentTarget.dataset.index; goToPage(idx+1);
        }));

        // navigation buttons
        document.getElementById('openBtn').addEventListener('click', ()=> {
          // open center page in focus
          const current = flipbookEl.turn('page');
          alert('Flipbook otvoren. Trenutna stranica: ' + current);
        });

        document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
        document.getElementById('downloadPdfBtn').addEventListener('click', downloadPdf);
      }

      function goToPage(n){
        $('#flipbook').turn('page', n);
      }

      // Fullscreen helper
      function toggleFullscreen(){
        const el = document.documentElement;
        if(!document.fullscreenElement){
          if(el.requestFullscreen) el.requestFullscreen();
        } else { if(document.exitFullscreen) document.exitFullscreen(); }
      }

      // Download PDF placeholder (client-side PDF generation of 24 high-res images can be heavy)
      function downloadPdf(){
        // For a performant and reliable PDF generation use server-side or a service (Cloudinary/CloudConvert).
        // Here we offer a light-weight client-side option using html2canvas + jsPDF for low-resolution proof.
        if(confirm('Preuzimanje u PDF formatu može potrajati. Želiš nastaviti (niska rezolucija)?')){
          importPdf();
        }
      }

      async function importPdf(){
        // Lazy-load libs
        const jsPdfUrl = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        const html2canvasUrl = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        await loadScript(html2canvasUrl);
        await loadScript(jsPdfUrl);
        const { jsPDF } = window.jspdf;

        const pdf = new jsPDF({unit:'px',format:[800,1131]});
        const pages = document.querySelectorAll('#flipbook .page');
        let i = 0;
        for(const p of pages){
          // render page to canvas
          // eslint-disable-next-line no-await-in-loop
          const canvas = await html2canvas(p, {scale:1.5, useCORS:true});
          const imgData = canvas.toDataURL('image/jpeg', 0.9);
          if(i>0) pdf.addPage();
          pdf.addImage(imgData,'JPEG',0,0,800,1131);
          i++;
        }
        pdf.save('IDSS-yearbook.pdf');
      }

      function loadScript(src){
        return new Promise((res, rej)=>{
          const s = document.createElement('script'); s.src = src; s.onload = res; s.onerror = rej; document.head.appendChild(s);
        });
      }

      // start preload
      preloadAll();

      // Small UX: if user opens file://, show a hint about Live Server / GitHub Pages
      if(location.protocol === 'file:'){
        const n = document.createElement('div'); n.style.position='fixed';n.style.left=10;n.style.bottom=10;n.style.padding='8px 12px';n.style.background='#fff8';n.style.backdropFilter='blur(4px)';n.style.borderRadius='8px';n.style.boxShadow='0 6px 18px rgba(0,0,0,0.06)';n.innerHTML = '⚠️ Pokrećeš iz file:// — preporučujem Live Server (VS Code) ili GitHub Pages za ispravan rad.';document.body.appendChild(n);
      }

    })(jQuery);
  </script>

</body>
</html>